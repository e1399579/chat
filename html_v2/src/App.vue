<template>
    <main>
        <lemon-imui :user="user" ref="im"
                    :hide-message-name="false"
                    @pull-messages="getHistory"
                    @message-click="messageClick"
                    @change-contact="changeContact"
                    @send="send">
            <!--聊天窗口标题-->
            <template #message-title="contact">
                <div class="flex space-between">
                    <span>{{contact.displayName}}<span v-if="contact.is_group"> ({{contact.online_total}})</span></span>
                    <b @click="toggleDrawer(contact)" class="pointer user-select-none">···</b>
                </div>
            </template>
            <!--聊天窗口右侧栏-->
            <template #drawer="contact">
                <div class="slot-group" v-if="contact.is_group">
                    <div class="slot-group-title">群通知</div>
                    <hr/>
                    <div class="slot-group-notice">公告内容</div>
                    <hr/>
                    <div class="slot-group-title">群成员</div>
                    <input class="slot-search" placeholder="搜索群成员"/>
                    <div class="slot-group-panel flex">
                        <template v-for="item of online_users.values()">
                            <div class="slot-group-member" :key="item.user_id" v-lemon-contextmenu="groupMenu(item, chatWith, im.closeDrawer)">
                                <div class="slot-group-avatar">
                                    <img :src="item.avatar ? item.avatar : default_avatar_url" alt="avatar" />
                                </div>
                                <div class="slot-group-name">{{item.username}}</div>
                            </div>
                        </template>
                    </div>
                </div>
            </template>
        </lemon-imui>
        <!--注册/登录弹框-->
        <modal name="login-modal" :clickToClose="false" :height="250" :width="500">
            <dialog class="box" open>
                <div id="bp-left" class="box-part">
                    <div id="partition-register" class="partition">
                        <div class="partition-title">请登录/注册</div>
                        <div class="partition-form">
                            <form autocomplete="off">
                                <input type="text" id="username" v-model="username" placeholder="起个名吧，亲:)"
                                       maxlength="30" autocomplete/>
                                <input type="password" id="password" v-model="password" placeholder="密码：默认123456"
                                       maxlength="16"/>
                                <button type="submit" class="large-btn github-btn" v-on:click="login">
                                    登录/注册
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div id="bp-right" class="box-part">
                    <div class="box-messages">{{login_mess}}</div>
                </div>
            </dialog>
        </modal>

        <!--掉线提示-->
        <modal name="disconnect-modal" :clickToClose="false" :height="25" :width="300">{{disconnect_mess}}</modal>

        <!--提示框-->
        <notifications group="tip" position="top center" />

        <!--图片预览-->
        <template>
            <!-- component -->
            <viewer :images="images">
                <img v-for="src in images" :key="src" :src="src">
            </viewer>
        </template>
    </main>
</template>

<script>
import './css/login.css';
import './css/main.css';

import {DataHelper, generateUUID} from './js/util.js';
import emoji from './js/emoji.js';
import default_avatar from './assets/chat.png';

const DEBUG = true;
const DEFAULT_AVATAR = default_avatar;
const MAX_LIMITS = 100; //断线最大重连次数
const COOKIE_EXPIRE_DAYS = 7; //cookie过期天数
const MAX_IMAGE_SIZE = 1024 * 1024 * 4; //最大上传图片尺寸
const MAX_MUSIC_SIZE = 1024 * 1024 * 16; //最大音乐尺寸
const MAX_FILE_SIZE = 1024 * 1024 * 50; //最大音乐尺寸

const MESSAGE_COMMON = 100;//公共消息
const MESSAGE_SELF = 101;//本人消息
const MESSAGE_OTHER = 102;//他人消息
const MESSAGE_PERSONAL = 103;//私信

const USER_ONLINE = 200;//用户上线
const USER_QUIT = 201;//用户退出
const USER_QUERY = 203; //用户查询
const USER_REGISTER = 204;//用户注册
const USER_LOGIN = 205; // 用户登录
const USER_DISABLED = 206;//用户禁用
const USER_DOWNLINE = 207;//用户下线
const USER_INCORRECT = 208;//用户名/密码错误
const USER_REMOVE = 209;//用户移除
const USER_ONLINE_TOTAL = 213; // 用户在线数量

const IMAGE_COMMON = 300;//公共图片
const IMAGE_SELF = 301;//本人图片
const IMAGE_OTHER = 302;//他人图片
const IMAGE_PERSONAL = 303;//私信图片

const MUSIC_COMMON = 500; //公共音乐
const MUSIC_SELF = 501; //本人音乐
const MUSIC_OTHER = 502; //他人音乐
const MUSIC_PERSONAL = 503; //私信音乐

const FILE_COMMON = 1000;
const FILE_SELF = 1001;
const FILE_OTHER = 1002;
const FILE_PERSONAL = 1003;

const HISTORY_MESSAGE_COMMON = 800; //历史公共消息
const HISTORY_MESSAGE_PERSONAL = 801; //历史个人消息
const FILE_UPLOAD_SUCCESS = 903; // 文件上传成功

export default {
    name: 'App',
    components: {},
    data() {
        return {
            im: null,
            server_url: process.env.VUE_APP_SERVER_URL,
            upload_url: process.env.VUE_APP_UPLOAD_URL,
            default_avatar_url: default_avatar,
            username: "",
            password: "",
            user: {id: 0, displayName: '', avatar: DEFAULT_AVATAR, is_active: 1},
            socket: null,
            reconnect_times: 0,
            login_mess: "",
            disconnect_mess: "",
            online_total: 0,
            online_users: new Map(),
            contact_query_time: new Map(),
            pull_next: new Map(),
            send_next: new Map(),
            query_next: new Map(),
            upload_next: new Map(),
            images: [],
        }
    },
    watch: {
    },
    mounted() {
        const {im} = this.$refs;
        this.im = im;
        generateUUID();

        // 连接服务器，监听事件
        this.socket = new WebSocket(this.server_url);
        // this.socket.binaryType = 'arraybuffer'; //设为二进制的原始缓冲区

        this.socket.addEventListener('open', this.onOpen);
        this.socket.addEventListener('message', this.onMessage);
        this.socket.addEventListener('close', this.onClose);
        this.socket.addEventListener('error', this.onError);

        // 菜单
        this.im.initMenus([{name: "messages"}, {name: "contacts"}]);

        // 初始化表情包
        this.im.initEmoji(emoji);

        // 初始化工具栏
        this.im.initEditorTools([
            {
                name: 'emoji'
            },
            {
                name: 'uploadImage'
            },
            {
                name: 'uploadDoc',
                title: "上传文档",
                click: () => {
                    this.im.$refs.editor.selectFile(".doc,.docx,.xls,.xlsx");
                },
                render: () => {
                    return <span>📄</span>;
                },
            },
            {
                name: "uploadMusic",
                title: "上传音乐",
                click: () => {
                    this.im.$refs.editor.selectFile(".mp3");
                },
                render: () => {
                    return <span>🎵</span>;
                },
            },
        ]);

        // 自定义消息-音乐
        this.im.setLastContentRender('music', (message) => {
            return <span>[音乐]{message.fileName}</span>;
        });

        // 大厅
        this.im.initContacts([{
            id: '0',
            displayName: "大厅",
            avatar: DEFAULT_AVATAR,
            index: "Group",
            unread: 0,

            // 新加字段
            online_total: 0,
            is_group: true,
        }]);
        this.contact_query_time.set('0', ((new Date()).getTime() + performance.now()) / 1000);
    },
    methods: {
        // 回调方法
        onOpen() {
            // 从cookie中获取信息
            let user = JSON.parse(this.getCookie('user'));
            if (typeof user === 'object') {
                this.user.id = user.id;
                this.user.displayName = user.displayName;
                this.user.avatar = user.avatar ? user.avatar : DEFAULT_AVATAR;
                this.sendMessage(USER_LOGIN);
            } else {
                this.$modal.show('login-modal');
            }
        },
        onMessage(message) {
            let mess = DataHelper.decode(message.data);
            mess.timestamp = mess.timestamp * 1000;
            this.trace("receive", mess);
            // let id = mess.receiver_id;
            // let trace_id = mess.trace_id;
            this.$modal.hide('disconnect-modal');
            switch (mess.type) {
                // 用户状态
                case MESSAGE_SELF://myself @other // TODO 修改消息样式
                case IMAGE_SELF:
                case FILE_SELF:
                case MUSIC_SELF:
                    break;
                case USER_REGISTER://需要注册
                    this.$modal.show('login-modal');
                    break;
                case USER_INCORRECT://登录出错
                    this.login_mess = mess.mess;
                    break;
                case USER_LOGIN://已经登录
                    this.login_mess = "登录成功";
                    this.$modal.hide('login-modal');
                    this.user.id = mess.user.user_id;
                    this.user.displayName = mess.user.username;
                    this.user.avatar = mess.user.avatar ? mess.user.avatar : DEFAULT_AVATAR;
                    this.setCookie("user", JSON.stringify(this.user));//刷新cookie
                    this.$modal.show('dialog', {
                        text: `${this.user.displayName}，欢迎回来`,
                        buttons: [
                            {
                                title: 'Cancel',
                                handler: () => {
                                    this.$modal.hide('dialog')
                                }
                            }
                        ]
                    });
                    this.$notify({
                        group: 'tip',
                        text: `${this.user.displayName}，欢迎回来`,
                        type: 'success',
                    });

                    // 查询在线人数
                    this.sendMessage(USER_ONLINE_TOTAL);
                    break;
                case USER_ONLINE://欢迎消息
                    // 联系人
                    this.im.appendMessage({
                        id: DataHelper.buildTraceId(),
                        status: "succeed",
                        type: "event",
                        sendTime: mess.timestamp,
                        content: `用户 ${mess.user.username} 进入聊天室`,
                        toContactId: "0",
                    });
                    if (this.user.id !== mess.user.user_id) {
                        ++this.online_total;
                        this.online_users.set(mess.user.user_id, mess.user);
                    }
                    this.updateContact("0", {online_total:this.online_total});
                    break;
                case USER_ONLINE_TOTAL:
                    this.online_total = mess.mess; // 置为实际数量
                    this.updateContact("0", {online_total:this.online_total});
                    break;
                case USER_QUIT:
                {
                    let user = mess.user;
                    this.im.appendMessage({
                        id: DataHelper.buildTraceId(),
                        status: "succeed",
                        type: "event",
                        sendTime: mess.timestamp,
                        content: `用户 ${user.username} 退出聊天室`,
                        toContactId: "0",
                        fromUser: ""
                    });
                    this.online_total = Math.max(--this.online_total, 1);
                    this.online_users.delete(user.user_id);
                    this.updateContact("0", {online_total:this.online_total});
                    break;
                }
                case USER_QUERY:
                {
                    let user = mess.user;
                    let user_id = user.user_id;
                    this.addUser(user);
                    // 执行下一步
                    let resolve = this.query_next.get(user_id);
                    if (resolve) {
                        resolve(user);
                    }
                    break;
                }
                case USER_DOWNLINE://下线
                case USER_REMOVE://移除
                case USER_DISABLED: //禁用
                {
                    this.user.is_active = 0;
                    this.disconnect_mess = this.disconnect_mess = mess.mess;
                    this.$modal.show('disconnect-modal');
                    break;
                }

                // 公共、个人消息
                case MESSAGE_COMMON: //公共消息
                case MESSAGE_OTHER: //other @me
                case IMAGE_COMMON:
                case IMAGE_OTHER:
                case MUSIC_COMMON:
                case MUSIC_OTHER:
                case FILE_COMMON:
                case FILE_OTHER:
                {
                    let sender_id = mess.sender_id;
                    if (sender_id === this.user.id) return; // 自己发的，忽略，避免重复
                    let sender = this.getUser(sender_id);
                    if (sender) {
                        this.receiveMessage(mess, sender);
                    } else {
                        // 若找不到用户，则查询异步处理
                        let promise = new Promise((resolve) => {
                            this.query_next.set(sender_id, resolve);
                            this.sendMessage(USER_QUERY, sender_id, "", sender_id);
                        });
                        promise.then((sender) => {
                            this.query_next.delete(sender.user_id);
                            // 显示联系人
                            this.updateContactFromUser(sender, mess.mess);
                            this.receiveMessage(mess, sender);
                        });
                    }
                    break;
                }

                case HISTORY_MESSAGE_COMMON:
                case HISTORY_MESSAGE_PERSONAL:
                {
                    let contact_id = mess.receiver_id;
                    let resolve = this.pull_next.get(contact_id);
                    if (resolve) {
                        resolve(mess);
                    }
                    break;
                }

                // 文件上传
                case FILE_UPLOAD_SUCCESS:
                {
                    // let hash = mess.mess.hash;
                    // let path = mess.mess.path;

                    let {hash, path, size} = mess.mess;
                    let resolve = this.upload_next.get(hash);
                    resolve(path, size);
                    break;
                }

                default:
                {
                    this.$notify({
                        group: 'tip',
                        text: '未知的消息类型：' + mess.type,
                        type: 'warn',
                    });
                }
            }
        },
        onClose() {
            // 联系人离线
            if (!this.user.is_active) return; // 被禁用
            if (this.socket.readyState === WebSocket.OPEN) return; // 重试多次时，避免连接成功后再次调用

            this.disconnect_mess = (new Date()).format() + ' 已断线，重试中...';
            this.$modal.show('disconnect-modal');
            let timer;
            let handler = () => {
                try {
                    //断线重连
                    if (this.reconnect_times >= MAX_LIMITS) {
                        window.clearInterval(timer);
                        this.$notify({
                            group: 'tip',
                            text: '无法连接到服务器，请稍候再试',
                            type: 'warn',
                        });
                        return this.$modal.hide('disconnect-modal');
                    }
                    if (this.socket.readyState === WebSocket.OPEN) {
                        window.clearInterval(timer);
                        this.socket.addEventListener('message', this.onMessage);
                        this.socket.addEventListener('close', this.onClose);
                        this.socket.addEventListener('error', this.onError);

                        this.onOpen();

                        this.reconnect_times = 0;
                        return this.$modal.hide('disconnect-modal');
                    }
                    this.socket = new WebSocket(this.server_url);
                    this.socket.binaryType = 'arraybuffer';
                    this.reconnect_times++;
                } catch (e) {
                    this.trace(e);
                }
            };
            timer = window.setInterval(handler, 2000);
        },
        onError(e) {
            this.trace(e);
            // Util.toast("连接服务器出错");
        },

        // 工具方法
        trace() {
            if (!DEBUG)
                return;
            let now = (window.performance.now() / 1000).toFixed(3);
            console.group(now);
            console.log(...arguments);
            // console.trace();
            console.groupEnd();
        },
        getCookie(name) {
            let nameEQ = name + "=";
            let ca = document.cookie.split(';');    //把cookie分割成组
            for (let c of ca) {
                while (c.charAt(0) === ' ') {          //判断一下字符串有没有前导空格
                    c = c.substring(1, c.length);      //有的话，从第二位开始取
                }
                if (c.indexOf(nameEQ) === 0) {       //如果含有我们要的name
                    return unescape(c.substring(nameEQ.length, c.length));    //解码并截取我们要值
                }
            }
            return false;
        },
        setCookie(name, value) {
            let exp = new Date();
            exp.setTime(exp.getTime() + COOKIE_EXPIRE_DAYS * 24 * 60 * 60 * 1000);
            document.cookie = name + "=" + escape(value) + ";expires=" + exp.toGMTString();
        },
        sendMessage(type, receiver_id = 0, mess = "", id = "", trace_id = "") {
            let defaults = {
                type: MESSAGE_COMMON,
                receiver_id: 0,
                mess: "",
                trace_id: trace_id ? trace_id : DataHelper.buildTraceId(),
            };
            let data = Object.assign(defaults, {
                type,
                sender_id: this.user.id,
                receiver_id,
                mess,
            });
            if (id) data.id = id;
            this.trace("send", data);
            this.socket.send(DataHelper.encode(data));
        },
        parseMessage(mess, sender = null) {
            let type, content, fileSize, fileName;
            switch (mess.type) {
                case MESSAGE_COMMON:
                case MESSAGE_SELF:
                case MESSAGE_OTHER:
                {
                    type = "text";
                    content = mess.mess;
                    fileSize = 0;
                    fileName = "";
                    break;
                }
                case IMAGE_COMMON:
                case IMAGE_SELF:
                case IMAGE_OTHER:
                {
                    type = "image";
                    content = this.upload_url + mess.mess.path;
                    fileSize = mess.mess.size;
                    fileName = mess.mess.name;
                    break;
                }
                case FILE_COMMON:
                case FILE_SELF:
                case FILE_OTHER:
                {
                    type = "file";
                    content = this.upload_url + mess.mess.path;
                    fileSize = mess.mess.size;
                    fileName = mess.mess.name;
                    break;
                }
                case MUSIC_COMMON:
                case MUSIC_SELF:
                case MUSIC_OTHER:
                {
                    type = "music";
                    content = this.upload_url + mess.mess.path;
                    fileSize = mess.mess.size;
                    fileName = mess.mess.name;
                    break;
                }
            }
            return {
                id: mess.id,
                status: "succeed",
                type,
                sendTime: mess.timestamp,
                content,
                toContactId: mess.receiver_id,
                fileSize,
                fileName,
                fromUser: {
                    //如果 id == this.user.id消息会显示在右侧，否则在左侧
                    id: mess.sender_id,
                    displayName: sender ? sender.username : '',
                    avatar: sender && sender.avatar ? sender.avatar : DEFAULT_AVATAR,
                }
            };
        },
        receiveMessage(mess, sender = null) {
            this.im.appendMessage(this.parseMessage(mess, sender));
        },
        updateContact(contact_id, option) {
            this.im.updateContact({
                id: contact_id,
                ...option,
            });
        },
        updateContactFromUser(user, lastMessage = "") {
            this.im.appendContact({
                id: user.user_id,
                displayName: user.username,
                avatar: user.avatar ? user.avatar : DEFAULT_AVATAR,
                lastContent: lastMessage,
                is_group: false,
            });
            this.im.updateContact({
                id: user.user_id,
                displayName: user.username,
                avatar: user.avatar ? user.avatar : DEFAULT_AVATAR,
                lastContent: lastMessage,
            });
        },
        addUser(user) {
            return this.online_users.set(user.user_id, user);
        },
        getUser(user_id) {
            return this.online_users.get(user_id);
        },

        // 交互方法
        login(e) {
            e.preventDefault();
            // 登录/注册
            this.socket.send(DataHelper.encode({
                type: USER_REGISTER,
                username: this.username.substr(0, 30),
                password: this.password ? this.password : '123456',
            }));
            return false;
        },
        getHistory(contact, next) {
            let _query_time = this.contact_query_time.get(contact.id);
            // 精确到4位，和服务器保持一致，并去除边界的一条
            let query_time = _query_time > 0 ? _query_time - 0.0001 : ((new Date()).getTime() + performance.now()) / 1000;
            let type = (contact.id === '0') ? HISTORY_MESSAGE_COMMON : HISTORY_MESSAGE_PERSONAL;
            // 异步查询历史消息
            let promise = new Promise((resolve, reject) => {
                try {
                    this.sendMessage(type, contact.id, query_time);
                    this.pull_next.set(contact.id, resolve); // 保存resolve
                } catch (e) {
                    reject(e);
                    this.trace(e);
                }
            });
            promise.then((mess) => {
                let query_id_list = new Set(); // 要查询的唯一用户ID
                let contact_id = mess.receiver_id;
                let list = mess.mess;
                this.pull_next.delete(contact_id); // 清除resolve
                list.length && this.contact_query_time.set(contact_id, list[0].timestamp); // 更新查询时间

                // 查询未知的用户信息，消息列表需要展示昵称和头像
                for (let one of list) {
                    let sender_id = one.sender_id;
                    let user = this.getUser(sender_id);
                    if (!user) {
                        query_id_list.add(sender_id);
                    }
                }
                let promise_list = [];
                query_id_list.forEach((user_id) => {
                    let promise2 = new Promise((resolve) => {
                        this.query_next.set(user_id, resolve);
                        this.sendMessage(USER_QUERY, user_id, "", "", user_id);
                    });
                    promise2.then((user) => {
                        this.updateContactFromUser(user);
                    });
                    promise_list.push(promise2);
                });
                // 用户信息全部查询完毕，再处理消息
                Promise.all(promise_list).then(() => {
                    let messages = [];
                    for (let one of list) {
                        let sender_id = one.sender_id;
                        let user = this.getUser(sender_id);
                        one.timestamp = one.timestamp * 1000;
                        messages.push(this.parseMessage(one, user));
                    }
                    let is_end = (list.length < 10);
                    // 将第二个参数设为true，表示已到末尾
                    next(messages, is_end);

                    // 清除resolve
                    query_id_list.forEach((user_id) => {
                        this.query_next.delete(user_id);
                    });
                });
            });
        },
        // 发送消息
        send(message, next, file) {
            try {
                this.trace('auto send', message, file);

                // 有文件时，修正type
                if (file) {
                    let music_types = [
                        "audio/mpeg",
                    ];
                    if (music_types.includes(file.type)) {
                        message.type = "music";
                    }
                }

                let receiver_id = message.toContactId;
                let is_personal = (receiver_id !== '0') + 0;
                let type_map = {
                    "image": [IMAGE_COMMON, IMAGE_PERSONAL],
                    "file": [FILE_COMMON, FILE_PERSONAL],
                    "text": [MESSAGE_COMMON, MESSAGE_PERSONAL],
                    "music": [MUSIC_COMMON, MUSIC_PERSONAL],
                };
                let type = type_map[message.type][is_personal];

                // 文本直接发送
                if (!file) {
                    this.sendMessage(type, receiver_id, message.content, message.id);
                    return next();
                }

                // 文件处理
                // TODO 文件压缩
                // audio/mpeg image/png
                let limit_size;
                switch (message.type) {
                    case "image":
                    default:
                        limit_size = MAX_IMAGE_SIZE;
                        break;
                    case "music":
                        limit_size = MAX_MUSIC_SIZE;
                        break;
                    case "file":
                        limit_size = MAX_FILE_SIZE;
                        break;
                }
                if (file.size > limit_size) {
                    this.$notify({
                        group: 'tip',
                        text: '文件太大，限制：<' + (limit_size / 1024 ** 2) + 'M',
                        type: 'error',
                    });
                    return next({status:'failed'});
                }

                let message_id = message.id;
                let func = async () => {
                    let buffer = await file.arrayBuffer();
                    let hashBuffer = await crypto.subtle.digest("SHA-256", buffer);
                    let hashArray = Array.from(new Uint8Array(hashBuffer)); // 将缓冲区转换为字节数组
                    const hash = hashArray.map((b) => b.toString(16).padStart(2, "0")).join(""); // 将字节数组转换为十六进制字符串
                    this.trace(hash);
                    let promise = new Promise((resolve) => {
                        this.socket.send(file); // WebSocket发送文件时无法携带其他信息
                        this.upload_next.set(hash, resolve);
                    });
                    promise.then((path) => {
                        this.upload_next.delete(hash);
                        let data = {
                            name: file.name,
                            path,
                            size: file.size,
                        };
                        this.sendMessage(type, receiver_id, data, message.id);
                        // 更新此条消息的URL
                        this.im.updateMessage({
                            id: message_id,
                            content: this.upload_url + path,
                        });
                        next();
                    });
                }
                func();
            } catch (e) {
                this.trace(e);
                next({status:'failed'});
            }
        },
        // 抽屉，显示群组/私聊成员
        toggleDrawer() {
            // let self = this;
            this.im.changeDrawer({
                position: "rightInside",
                offsetY: 33,
                height: this.$el.clientHeight - 33,
            });
        },
        chatWith(user) {
            this.updateContactFromUser(user, "临时会话");
            this.im.changeContact(user.user_id);
        },
        messageClick(e, key, message) {
            let contact_id = message.toContactId;
            // 标记为已读
            this.updateContact(contact_id, {unread: 0});

            this.trace(e, key, message);
            if (message.type === "image") {
                this.imagePreview(message.content);
            }
        },
        changeContact(contact) {
            this.updateContact(contact.id, {unread: 0});
        },

        // 图片预览
        imagePreview(url) {
            let images = document.querySelectorAll(".lemon-message__content img");
            let index = 0;
            this.images = [];
            images.forEach((image, i) => {
                this.images.push(image.src);
                if (image.src === url) {
                    index = i;
                }
            });
            console.log(this.images);
            this.$viewerApi({
                images: this.images,
                options: {
                    toolbar: true,
                    initialViewIndex: index,
                },
            });
        },

        // 打开公告
        openNotice() {
            return '';
        },

        // 添加成员
        openAddGroupUser() {},

        // 成员菜单
        groupMenu(item, before, after) {
            return (item.user_id === this.user.id) ? [] : [
                {
                    text: "发消息",
                    click(e, instance, hide) {
                        before(item);
                        hide();
                        after();
                    },
                },
            ];
        },
    }
}
</script>