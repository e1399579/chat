(function(){"use strict";var e={1643:function(e,t,s){var i=s(2856),a=function(){var e=this,t=e._self._c;return t("main",[t("lemon-imui",{ref:"im",attrs:{user:e.user,"hide-message-name":!1,avatarCricle:!0,width:e.width,height:e.height},on:{"pull-messages":e.getHistory,"message-click":e.messageClick,"change-contact":e.changeContact,"menu-avatar-click":e.changeAvatar,send:e.send},scopedSlots:e._u([{key:"sidebar-message-fixedtop",fn:function(){return[t("div",{staticClass:"flex space-between search-bar"},[t("input",{staticClass:"input-medium",attrs:{type:"text",placeholder:"搜索"}}),t("button",{on:{click:e.addGroup}},[e._v("➕")])])]},proxy:!0},{key:"sidebar-message",fn:function(s){return[t("lemon-badge",{staticClass:"lemon-contact__avatar",attrs:{count:s.unread}},[t("lemon-avatar",{attrs:{size:40,src:s.avatar}})],1),t("div",{staticClass:"lemon-contact__inner"},[t("p",{staticClass:"lemon-contact__label"},[s.is_online?t("span",{staticClass:"online-status"}):e._e(),t("span",{staticClass:"lemon-contact__name"},[e._v(e._s(s.displayName))]),t("span",{staticClass:"lemon-contact__time"},[e._v(e._s(s.lastSendTime?e.timeFormat(s.lastSendTime):"")+" ")])]),t("p",{staticClass:"lemon-contact__content"},[t("span",{domProps:{innerHTML:e._s(s.lastContent)}})])])]}},{key:"message-title",fn:function(s){return[t("div",{staticClass:"flex space-between"},[t("span",[e._v(e._s(s.displayName)),s.is_group?t("span",[e._v(" ("+e._s(s.id?s.members.size:s.online_total)+")")]):e._e()]),t("b",{staticClass:"pointer user-select-none",on:{click:function(t){return e.toggleDrawer(s)}}},[e._v("···")])])]}},{key:"drawer",fn:function(s){return[s.is_group?t("div",{staticClass:"slot-group"},[t("div",{staticClass:"slot-group-title"},[e._v("群通知")]),t("hr"),t("div",{staticClass:"slot-group-notice"},[e._v("公告内容")]),t("hr"),t("div",{staticClass:"slot-group-title"},[e._v("群成员")]),t("input",{staticClass:"slot-search",attrs:{placeholder:"搜索群成员"}}),t("div",{staticClass:"slot-group-panel flex flex-top"},e._l(s.members.values(),(function(s){return t("lemon-contact",{directives:[{name:"lemon-contextmenu",rawName:"v-lemon-contextmenu.contact",value:e.group_menu,expression:"group_menu",modifiers:{contact:!0}}],key:s.user_id,attrs:{contact:s}},[t("div",{staticClass:"slot-group-member"},[t("div",{staticClass:"slot-group-avatar"},[t("img",{attrs:{src:s.avatar?e.upload_url+s.avatar:e.default_avatar_url,alt:"avatar"}})]),t("div",{staticClass:"slot-group-name text-ellipsis"},[e._v(e._s(s.username))])])])})),1)]):e._e()]}}])}),t("modal",{attrs:{name:"login-modal",clickToClose:!1,height:250,width:250,adaptive:!0}},[t("dialog",{staticClass:"box",attrs:{open:""}},[t("div",{staticClass:"partition-title"},[e._v("请登录/注册")]),t("div",{staticClass:"partition-form"},[t("form",{attrs:{autocomplete:"off"}},[t("input",{directives:[{name:"model",rawName:"v-model",value:e.username,expression:"username"}],attrs:{type:"text",id:"username",placeholder:"起个名吧，亲:)",maxlength:"30",autocomplete:""},domProps:{value:e.username},on:{input:function(t){t.target.composing||(e.username=t.target.value)}}}),t("input",{directives:[{name:"model",rawName:"v-model",value:e.password,expression:"password"}],attrs:{type:"password",id:"password",placeholder:"密码：默认123456",maxlength:"16"},domProps:{value:e.password},on:{input:function(t){t.target.composing||(e.password=t.target.value)}}}),t("button",{staticClass:"large-btn gold-btn",attrs:{type:"submit"},on:{click:e.login}},[e._v(" 登录/注册 ")])])])])]),t("modal",{attrs:{name:"disconnect-modal",clickToClose:!1,height:25,width:300}},[e._v(e._s(e.disconnect_mess))]),t("notifications",{attrs:{group:"tip",position:"top center"}}),t("viewer",{attrs:{images:e.images}}),[t("image-crop",{attrs:{field:"img",width:300,height:300,"img-format":"png"},on:{"crop-success":e.cropSuccess},model:{value:e.image_crop.show,callback:function(t){e.$set(e.image_crop,"show",t)},expression:"image_crop.show"}})],t("modal",{attrs:{name:"group-modal",clickToClose:!0,height:500,width:666,adaptive:!0}},[t("div",{staticClass:"modal-content"},[t("div",{staticClass:"modal-header"},[t("h3",{staticClass:"modal-title"},[e._v("创建群聊")]),t("span",[e._v("群聊名称：")]),t("input",{directives:[{name:"model",rawName:"v-model",value:e.group_name,expression:"group_name"}],staticClass:"input-medium group-name",attrs:{placeholder:"请输入群聊名称"},domProps:{value:e.group_name},on:{input:function(t){t.target.composing||(e.group_name=t.target.value)}}})]),t("div",{staticClass:"flex space-between vertical-center modal-body"},[t("div",{staticClass:"group-select"},[t("div",[e._v("联系人")]),t("select",{directives:[{name:"model",rawName:"v-model",value:e.left_options,expression:"left_options"}],attrs:{multiple:"",size:"10"},on:{change:function(t){var s=Array.prototype.filter.call(t.target.options,(function(e){return e.selected})).map((function(e){var t="_value"in e?e._value:e.value;return t}));e.left_options=t.target.multiple?s:s[0]}}},e._l(e.group_available_users.values(),(function(s){return t("option",{key:s.user_id,domProps:{value:s.user_id}},[e._v(e._s(s.username))])})),0)]),t("div",{staticClass:"group-select-middle"},[t("button",{on:{click:e.moveToLeft}},[e._v("⬅️")]),t("button",{on:{click:e.moveToRight}},[e._v("➡️")])]),t("div",{staticClass:"group-select"},[t("div",[e._v("已选")]),t("select",{directives:[{name:"model",rawName:"v-model",value:e.right_options,expression:"right_options"}],attrs:{multiple:"",size:"10"},on:{change:function(t){var s=Array.prototype.filter.call(t.target.options,(function(e){return e.selected})).map((function(e){var t="_value"in e?e._value:e.value;return t}));e.right_options=t.target.multiple?s:s[0]}}},e._l(e.group_chosen_users.values(),(function(s){return t("option",{key:s.user_id,domProps:{value:s.user_id}},[e._v(e._s(s.username))])})),0)])]),t("div",{staticClass:"flex horizontal-right modal-footer"},[t("button",{on:{click:e.groupCancel}},[e._v("取消")]),t("button",{on:{click:e.groupSubmit}},[e._v("确定")])])])]),t("modal",{directives:[{name:"show",rawName:"v-show",value:!e.rtc_minimize,expression:"!rtc_minimize"}],attrs:{name:"rtc-modal",clickToClose:!1,height:"auto",width:960,scrollable:!0,draggable:"true"}},[t("div",{staticClass:"flex flex-wrap horizontal-center vertical-center"},[e.video_flag?[t("div",{staticClass:"local-video"},[t("video",{attrs:{autoplay:"",muted:""},domProps:{muted:!0,srcObject:e.local_media}}),t("div",{staticClass:"flex video-bar"},[t("div",{staticClass:"video-tag text-ellipsis"},[e._v(e._s(e.user.displayName))]),t("canvas",{staticClass:"voice-visualize-canvas",attrs:{id:"local-canvas",width:"420",height:"30"}})])]),e._l(e.remote_medias,(function([s,i]){return t("div",{key:s,staticClass:"remote-video"},[t("video",{attrs:{autoplay:""},domProps:{srcObject:i}}),t("div",{staticClass:"flex video-bar"},[t("div",{staticClass:"video-tag text-ellipsis"},[e._v(e._s(e.remote_users.get(s).username))]),t("canvas",{staticClass:"voice-visualize-canvas",attrs:{id:"remote-canvas-"+s,width:"420",height:"30"}})])])}))]:[t("div",{staticClass:"local-audio"},[t("audio",{attrs:{autoplay:"",muted:""},domProps:{srcObject:e.local_media},on:{canplay:e.setMute}}),t("div",{staticClass:"flex audio-bar"},[t("div",[t("img",{attrs:{src:e.user.avatar}}),t("div",{staticClass:"text-ellipsis text-center username"},[e._v(e._s(e.user.displayName))])]),t("canvas",{staticClass:"voice-visualize-canvas",attrs:{id:"local-canvas",width:"380",height:"120"}})])]),e._l(e.remote_medias,(function([s,i]){return t("div",{key:s,staticClass:"remote-audio"},[t("audio",{attrs:{autoplay:""},domProps:{srcObject:i}}),t("div",{staticClass:"flex audio-bar"},[t("div",[t("img",{attrs:{src:e.remote_users.get(s).avatar?e.upload_url+e.remote_users.get(s).avatar:e.default_avatar_url}}),t("div",{staticClass:"text-ellipsis text-center username"},[e._v(e._s(e.remote_users.get(s).username))])]),t("canvas",{staticClass:"voice-visualize-canvas",attrs:{id:"remote-canvas-"+s,width:"380",height:"120"}})])])}))]],2),t("div",{staticClass:"flex space-between vertical-center"},[t("div",[t("button",{staticClass:"minimize-button",on:{click:e.minimize}},[e._v("➖最小化")])]),t("div",{staticClass:"flex vertical-center"},[t("span",[e._v(e._s(e.clock_text))]),t("button",{staticClass:"flex vertical-center",on:{click:e.hangUp}},[t("span",{staticClass:"hang-up-button"}),t("span",[e._v("结束通话")])])])])]),t("v-dialog"),t("div",{directives:[{name:"show",rawName:"v-show",value:e.rtc_minimize,expression:"rtc_minimize"}],staticClass:"minimize-call flex flex-wrap horizontal-center"},[t("button",{staticClass:"call-button",on:{click:e.maximize}}),t("div",[e._v(e._s(e.clock_text))])])],2)},r=[],n=[{label:"长草颜",children:[{name:"ywz_1",title:"不想活了",src:"/static/emoji/ywz/1.gif"},{name:"ywz_2",title:"不要啦",src:"/static/emoji/ywz/2.gif"},{name:"ywz_3",title:"买买买",src:"/static/emoji/ywz/3.gif"},{name:"ywz_4",title:"伤心",src:"/static/emoji/ywz/4.gif"},{name:"ywz_5",title:"剁剁剁",src:"/static/emoji/ywz/5.gif"},{name:"ywz_6",title:"加油",src:"/static/emoji/ywz/6.gif"},{name:"ywz_7",title:"厉害哦",src:"/static/emoji/ywz/7.gif"},{name:"ywz_8",title:"吃吃吃",src:"/static/emoji/ywz/8.gif"},{name:"ywz_9",title:"吓尿了",src:"/static/emoji/ywz/9.gif"},{name:"ywz_10",title:"哈哈",src:"/static/emoji/ywz/10.gif"},{name:"ywz_11",title:"喜欢你",src:"/static/emoji/ywz/11.gif"},{name:"ywz_12",title:"对不起",src:"/static/emoji/ywz/12.gif"},{name:"ywz_13",title:"小鲜肉",src:"/static/emoji/ywz/13.gif"},{name:"ywz_14",title:"快点",src:"/static/emoji/ywz/14.gif"},{name:"ywz_15",title:"惊吓",src:"/static/emoji/ywz/15.gif"},{name:"ywz_16",title:"生日快乐",src:"/static/emoji/ywz/16.gif"},{name:"ywz_17",title:"有钱",src:"/static/emoji/ywz/17.gif"},{name:"ywz_18",title:"生气",src:"/static/emoji/ywz/18.gif"},{name:"ywz_19",title:"美妙极了",src:"/static/emoji/ywz/19.gif"},{name:"ywz_20",title:"肚子饿",src:"/static/emoji/ywz/20.gif"},{name:"ywz_21",title:"臭美",src:"/static/emoji/ywz/21.gif"},{name:"ywz_22",title:"鄙视",src:"/static/emoji/ywz/22.gif"},{name:"ywz_23",title:"闪瞎啦",src:"/static/emoji/ywz/23.gif"},{name:"ywz_24",title:"鬼脸",src:"/static/emoji/ywz/24.gif"}]},{label:"野萌君",children:[{name:"ymj_0",title:"恭喜发财",src:"/static/emoji/ymj/0.gif"},{name:"ymj_1",title:"哀求",src:"/static/emoji/ymj/1.gif"},{name:"ymj_2",title:"加油",src:"/static/emoji/ymj/2.gif"},{name:"ymj_3",title:"滚",src:"/static/emoji/ymj/3.gif"},{name:"ymj_4",title:"哇",src:"/static/emoji/ymj/4.gif"},{name:"ymj_5",title:"好委屈",src:"/static/emoji/ymj/5.gif"},{name:"ymj_6",title:"我滚啦",src:"/static/emoji/ymj/6.gif"},{name:"ymj_7",title:"你慢慢吃",src:"/static/emoji/ymj/7.gif"},{name:"ymj_8",title:"好烦",src:"/static/emoji/ymj/8.gif"},{name:"ymj_9",title:"干不掉我",src:"/static/emoji/ymj/9.gif"},{name:"ymj_10",title:"出去玩",src:"/static/emoji/ymj/10.gif"},{name:"ymj_11",title:"哈哈",src:"/static/emoji/ymj/11.gif"},{name:"ymj_12",title:"睡觉",src:"/static/emoji/ymj/12.gif"},{name:"ymj_13",title:"看不惯我",src:"/static/emoji/ymj/13.gif"},{name:"ymj_14",title:"咋啦",src:"/static/emoji/ymj/14.gif"},{name:"ymj_15",title:"你最好了",src:"/static/emoji/ymj/15.gif"},{name:"ymj_16",title:"保佑我",src:"/static/emoji/ymj/16.gif"},{name:"ymj_17",title:"不",src:"/static/emoji/ymj/17.gif"},{name:"ymj_18",title:"嗯",src:"/static/emoji/ymj/18.gif"},{name:"ymj_19",title:"嗨",src:"/static/emoji/ymj/19.gif"},{name:"ymj_20",title:"么么哒",src:"/static/emoji/ymj/20.gif"},{name:"ymj_21",title:"刚怎么了",src:"/static/emoji/ymj/21.gif"},{name:"ymj_22",title:"好棒",src:"/static/emoji/ymj/22.gif"},{name:"ymj_23",title:"别闹",src:"/static/emoji/ymj/23.gif"}]}];class o{constructor(e=null){this.config=e||{iceServers:[{urls:["stun:stun.l.google.com:19302","stun:stun.files.fm:3478"]},{urls:"turns:freestun.net:5350",username:"free",credential:"free"}]},this.constraints={audio:!0,video:!0},this.callbacks={},this.pcs=new Map,this.stream=null,this.timers=new Map}setCallbacks(e){const{onTrack:t,onNegotiateReady:s,onIceCandidate:i,onRemoteSteamClose:a}=e;this.callbacks.onTrack=t,this.callbacks.onNegotiateReady=s,this.callbacks.onIceCandidate=i,this.callbacks.onRemoteSteamClose=a}setConstraints(e){this.constraints=e}async open(){try{return this.stream||(this.stream=await navigator.mediaDevices.getUserMedia(this.constraints)),this.stream}catch(e){switch(console.error(e),e.name){case"NotFoundError":alert("No camera or microphone were found.");break;case"SecurityError":case"PermissionDeniedError":break;default:alert(`Error opening your camera or microphone: ${e.message}`);break}throw new Error("open media failed")}}create(){let e=new RTCPeerConnection(this.config),t=this.getPeerConnectionLastId();return this.pcs.set(t,e),e.ontrack=({track:e,streams:s})=>{e.onunmute=()=>{this.callbacks.onTrack(t,s)}},e.onnegotiationneeded=async e=>{try{let s=e.target,i=await s.createOffer({iceRestart:!0});i.sdp=this.replaceSDP(i.sdp),await s.setLocalDescription(i),this.callbacks.onNegotiateReady(t,s.localDescription)}catch(e){console.error("onnegotiationneeded error",e)}},e.onicecandidate=({candidate:e})=>{this.callbacks.onIceCandidate(t,e)},e.oniceconnectionstatechange=e=>{let s=e.target;switch(console.log("oniceconnectionstatechange",s.iceConnectionState),s.iceConnectionState){case"closed":this.close(t);break;case"failed":s.restartIce();break;case"disconnected":this.timers.set(t,setTimeout((e=>{console.log("restart ice"),e.restartIce()}),3e3,s));break;case"connected":this.timers.has(t)&&clearTimeout(this.timers.get(t));break}},e.onicegatheringstatechange=e=>{let t=e.target;console.log("onicegatheringstatechange",t.iceGatheringState)},e.onsignalingstatechange=e=>{let s=e.target;switch(console.log("onsignalingstatechange",s.signalingState),s.signalingState){case"closed":this.close(t);break}},t}addTrack(e){let t=this.pcs.get(e);for(const s of this.stream.getTracks())t.addTrack(s,this.stream)}close(e){let t=this.pcs.get(e);t.ontrack=null,t.onremovetrack=null,t.onremovestream=null,t.onicecandidate=null,t.oniceconnectionstatechange=null,t.onsignalingstatechange=null,t.onicegatheringstatechange=null,t.onnegotiationneeded=null,t.close(),t=null,this.pcs.delete(e),this.timers.delete(e),this.callbacks.onRemoteSteamClose(e)}closeAll(){this.pcs.forEach(((e,t)=>{this.close(t)})),this.pcs.clear(),this.stream=null,this.timers.clear()}getPeerConnectionLastId(){return this.pcs.size}async handleVideoOfferMsg(e,t=-1){let s,i;-1===t?(s=this.create(),i=this.pcs.get(s),await i.setRemoteDescription(e),await this.open(),this.addTrack(s)):(s=t,i=this.pcs.get(s),await i.setRemoteDescription(e));let a=await i.createAnswer();return a.sdp=this.replaceSDP(a.sdp),await i.setLocalDescription(a),{key:s,description:i.localDescription}}async handleVideoAnswerMsg(e,t){try{let s=this.pcs.get(e);return await s.setRemoteDescription(t)}catch(s){console.log("setRemoteDescription error",s)}}async handleNewICECandidateMsg(e,t){try{let s=this.pcs.get(e);return await s.addIceCandidate(t)}catch(s){console.log("addIceCandidate error",s)}}replaceSDP(e){return e.replace("useinbandfec=1","useinbandfec=1; stereo=1; maxaveragebitrate=128000")}}var c=s(2473);class l{}(0,c.A)(l,"DEBUG",!0),(0,c.A)(l,"DEFAULT_AVATAR","/static/chat.png"),(0,c.A)(l,"MAX_LIMITS",100),(0,c.A)(l,"COOKIE_EXPIRE_DAYS",7),(0,c.A)(l,"MAX_IMAGE_SIZE",4194304),(0,c.A)(l,"MAX_MUSIC_SIZE",16777216),(0,c.A)(l,"MAX_FILE_SIZE",52428800),(0,c.A)(l,"MESSAGE_COMMON",100),(0,c.A)(l,"MESSAGE_SELF",101),(0,c.A)(l,"MESSAGE_OTHER",102),(0,c.A)(l,"MESSAGE_PERSONAL",103),(0,c.A)(l,"USER_ONLINE",200),(0,c.A)(l,"USER_QUIT",201),(0,c.A)(l,"USER_LIST",202),(0,c.A)(l,"USER_QUERY",203),(0,c.A)(l,"USER_REGISTER",204),(0,c.A)(l,"USER_LOGIN",205),(0,c.A)(l,"USER_DISABLED",206),(0,c.A)(l,"USER_DOWNLINE",207),(0,c.A)(l,"USER_INCORRECT",208),(0,c.A)(l,"USER_REMOVE",209),(0,c.A)(l,"USER_AVATAR_UPLOAD",210),(0,c.A)(l,"USER_AVATAR_SUCCESS",211),(0,c.A)(l,"USER_AVATAR_FAIL",212),(0,c.A)(l,"USER_ONLINE_TOTAL",213),(0,c.A)(l,"IMAGE_COMMON",300),(0,c.A)(l,"IMAGE_SELF",301),(0,c.A)(l,"IMAGE_OTHER",302),(0,c.A)(l,"IMAGE_PERSONAL",303),(0,c.A)(l,"MUSIC_COMMON",500),(0,c.A)(l,"MUSIC_SELF",501),(0,c.A)(l,"MUSIC_OTHER",502),(0,c.A)(l,"MUSIC_PERSONAL",503),(0,c.A)(l,"FILE_COMMON",1e3),(0,c.A)(l,"FILE_SELF",1001),(0,c.A)(l,"FILE_OTHER",1002),(0,c.A)(l,"FILE_PERSONAL",1003),(0,c.A)(l,"GROUP_CREATE",1100),(0,c.A)(l,"GROUP_QUERY_LIST",1101),(0,c.A)(l,"GROUP_QUERY_MEMBER",1102),(0,c.A)(l,"GROUP_QUERY_INFO",1103),(0,c.A)(l,"RTC_CREATE",600),(0,c.A)(l,"RTC_JOIN",601),(0,c.A)(l,"RTC_MESSAGE",602),(0,c.A)(l,"RTC_OFFLINE",603),(0,c.A)(l,"RTC_CLOSE",604),(0,c.A)(l,"RTC_EXIT",605),(0,c.A)(l,"HISTORY_MESSAGE_COMMON",800),(0,c.A)(l,"HISTORY_MESSAGE_PERSONAL",801),(0,c.A)(l,"ERROR",900),(0,c.A)(l,"WARNING",901),(0,c.A)(l,"SYSTEM",902),(0,c.A)(l,"FILE_UPLOAD_SUCCESS",903);s(4114),s(3375),s(9225),s(3972),s(9209),s(5714),s(7561),s(6197);class d{setNext(e){this.next=e}getNext(){return this.next}}s(6573),s(8100),s(7936),s(7467),s(4732),s(9577);class m{static encode(e){return JSON.stringify(e)}static decode(e){return JSON.parse(e)}static toObject(e){let t={};for(let s in e)t[s]=e[s];return t}static buildTraceId(){return Math.random().toString(36).substr(2,10)}static async sha256(e){let t=await e.arrayBuffer(),s=await crypto.subtle.digest("SHA-256",t),i=Array.from(new Uint8Array(s));return i.map((e=>e.toString(16).padStart(2,"0"))).join("")}}function u(){let e=(new Date).getTime();return e+=performance.now(),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){let s=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?s:3&s|8).toString(16)}))}String.prototype.replaceMulti=function(e,t){let s=this;return e.forEach(((e,i)=>{s=s.replace(new RegExp(e,"gi"),t[i])})),s},Date.prototype.format=function(e="Y-m-d H:i:s"){let t=["Y","m","d","H","i","s","y"],s=[this.getFullYear(),(this.getMonth()+1).toString().padStart(2,"0"),this.getDate().toString().padStart(2,"0"),this.getHours().toString().padStart(2,"0"),this.getMinutes().toString().padStart(2,"0"),this.getSeconds().toString().padStart(2,"0"),this.getFullYear().toString().padStart(4,"0").substring(2)];return e.replaceMulti(t,s)},Date.prototype.formatUTC=function(e="Y-m-d H:i:s"){let t=["Y","m","d","H","i","s","y"],s=[this.getUTCFullYear(),(this.getUTCMonth()+1).toString().padStart(2,"0"),this.getUTCDate().toString().padStart(2,"0"),this.getUTCHours().toString().padStart(2,"0"),this.getUTCMinutes().toString().padStart(2,"0"),this.getUTCSeconds().toString().padStart(2,"0"),this.getUTCFullYear().toString().padStart(4,"0").substring(2)];return e.replaceMulti(t,s)};class _{constructor(){this.methods=this.getMethods(),this.data=this.getData}getData(){}getMethods(){}}class h extends d{process(e,t){switch(t.type){case l.MESSAGE_SELF:case l.IMAGE_SELF:case l.FILE_SELF:case l.MUSIC_SELF:break;case l.USER_REGISTER:e.$modal.show("login-modal");break;case l.USER_INCORRECT:e.$notify({group:"tip",text:t.mess,type:"error"});break;case l.USER_LOGIN:{let s=t.user;e.$modal.hide("login-modal"),e.user.id=s.user_id,e.user.displayName=s.username,e.user.avatar=s.avatar?e.upload_url+s.avatar:l.DEFAULT_AVATAR,e.user.is_active=parseInt(s.is_active),e.user.is_super_admin=s.is_super_admin,e.setCookie("user",JSON.stringify(e.user)),e.online_users.set(s.user_id,s),e.$notify({group:"tip",text:`${e.user.displayName}，欢迎回来`,type:"success"}),e.sendMessage(l.USER_ONLINE_TOTAL),e.sendMessage(l.GROUP_QUERY_LIST),e.sendMessage(l.USER_LIST);break}case l.USER_LIST:{let s=t.users;for(let t of s)e.online_users.set(t.user_id,t);break}case l.USER_ONLINE:{let s=t.user;e.im.appendMessage({id:u(),status:"succeed",type:"event",sendTime:t.timestamp,content:`用户 ${s.username} 进入聊天室`,toContactId:"0"},!0),e.user.id!==s.user_id&&(++e.online_total,s.is_online=!0,e.online_users.set(s.user_id,s),e.updateContact(s.user_id,{is_online:!0}),e.updateContact("0",{online_total:e.online_total,unread:"+1"}));break}case l.USER_ONLINE_TOTAL:e.online_total=t.mess,e.updateContact("0",{online_total:e.online_total});break;case l.USER_QUIT:{let s=t.user;e.user.id!==s.user_id&&(e.im.appendMessage({id:u(),status:"succeed",type:"event",sendTime:t.timestamp,content:`用户 ${s.username} 退出聊天室`,toContactId:"0",fromUser:""},!0),e.online_total=Math.max(--e.online_total,1),e.online_users.delete(s.user_id),e.updateContact("0",{online_total:e.online_total,unread:"+1"}),e.updateContact(s.user_id,{is_online:!1}));break}case l.USER_QUERY:{let s=t.user,i=s.user_id;e.addUser(s);let a=e.query_next.get(i);a&&a(s);break}case l.USER_DOWNLINE:case l.USER_REMOVE:case l.USER_DISABLED:e.user.is_active=0,e.disconnect_mess=t.mess,e.$modal.show("disconnect-modal");break;case l.USER_AVATAR_SUCCESS:{e.user.avatar=e.upload_url+t.mess,e.setCookie("user",JSON.stringify(e.user));let s=e.online_users.get(e.user.id);s.avatar=t.mess,e.online_users.set(e.user.id,s),e.$notify({group:"tip",text:"上传头像成功",type:"success"});break}case l.USER_AVATAR_FAIL:e.$notify({group:"tip",text:"上传头像失败",type:"warn"});break;case l.MESSAGE_COMMON:case l.MESSAGE_OTHER:case l.IMAGE_COMMON:case l.IMAGE_OTHER:case l.MUSIC_COMMON:case l.MUSIC_OTHER:case l.FILE_COMMON:case l.FILE_OTHER:{let s=t.sender_id;if(s===e.user.id)return;let i=t.receiver_id,a=i&&i!==e.user.id;if(a){let t=e.im.findContact(i);if(!t){e.sendMessage(l.GROUP_QUERY_INFO,"0",i);let t=new Promise((t=>{e.query_group_next.set(i,t)}));t.then((t=>{e.query_group_next.delete(t.id),e.addGroupContact(t)}))}}e.getUserAsync(s,(s=>{e.addPersonalContact(s),e.receiveMessage(t,s)}));break}case l.HISTORY_MESSAGE_COMMON:case l.HISTORY_MESSAGE_PERSONAL:{let s=t.receiver_id,i=e.pull_next.get(s);i&&i(t);break}case l.FILE_UPLOAD_SUCCESS:{let s=e.upload_next.get(t.mess.hash);s(t.mess);break}case l.ERROR:case l.WARNING:case l.SYSTEM:e.receiveMessage(t);break;default:this.next.process(e,t);break}}}class p extends _{getData(){return{im:null,server_url:"",upload_url:"",default_avatar_url:l.DEFAULT_AVATAR,width:window.innerWidth-16,height:window.innerHeight-16,username:"",password:"",user:{id:0,displayName:"",avatar:l.DEFAULT_AVATAR,is_active:1,is_super_admin:!1},socket:null,reconnect_times:0,disconnect_mess:"",online_total:0,online_users:new Map,pull_next:new Map,send_next:new Map,query_next:new Map,upload_next:new Map,query_member_next:new Map,query_group_next:new Map,images:[],image_crop:{show:!1}}}getMethods(){return{onOpen(){let e=JSON.parse(this.getCookie("user"));"object"===typeof e?(this.user.id=e.id,this.user.displayName=e.displayName,this.user.avatar=e.avatar?e.avatar:l.DEFAULT_AVATAR,this.user.is_active=parseInt(e.is_active),this.user.is_super_admin=e.is_super_admin,this.sendMessage(l.USER_LOGIN)):this.$modal.show("login-modal")},onMessage(e){let t=m.decode(e.data);t.timestamp=1e3*t.timestamp,this.trace("receive",t),this.$modal.hide("disconnect-modal"),this.message_handler.process(this,t)},onClose(){if(!this.user.is_active)return;if(this.socket.readyState===WebSocket.OPEN)return;let e;this.disconnect_mess=(new Date).format()+" 已断线，重试中...",this.$modal.show("disconnect-modal");let t=()=>{try{if(this.reconnect_times>=l.MAX_LIMITS)return window.clearInterval(e),this.$notify({group:"tip",text:"无法连接到服务器，请稍候再试",type:"warn"}),this.$modal.hide("disconnect-modal");if(this.socket.readyState===WebSocket.OPEN)return window.clearInterval(e),this.socket.addEventListener("message",this.onMessage),this.socket.addEventListener("close",this.onClose),this.socket.addEventListener("error",this.onError),this.onOpen(),this.reconnect_times=0,this.$modal.hide("disconnect-modal");this.socket=new WebSocket(this.server_url),this.socket.binaryType="arraybuffer",this.reconnect_times++}catch(t){this.trace(t)}};e=window.setInterval(t,2e3)},onError(e){this.trace(e),this.$notify({group:"tip",text:"连接服务器出错",type:"error"})},timeFormat(e){let t=new Date(e),s=(new Date).getTime()-t.getTime()<864e5,i=s?"H:i":"y.m.d H:i";return t.format(i)},trace(){if(!l.DEBUG)return;let e=(window.performance.now()/1e3).toFixed(3);console.group(e),console.log(...arguments),console.groupEnd()},getCookie(e){let t=e+"=",s=document.cookie.split(";");for(let i of s){while(" "===i.charAt(0))i=i.substring(1,i.length);if(0===i.indexOf(t))return unescape(i.substring(t.length,i.length))}return!1},setCookie(e,t){let s=new Date;s.setTime(s.getTime()+24*l.COOKIE_EXPIRE_DAYS*60*60*1e3),document.cookie=e+"="+escape(t)+";expires="+s.toGMTString()},sendMessage(e,t="0",s=null,i="",a=""){let r={type:l.MESSAGE_COMMON,receiver_id:"0",mess:"",trace_id:a||m.buildTraceId()},n=Object.assign(r,{type:e,sender_id:this.user.id,receiver_id:t,mess:s});i&&(n.id=i),this.trace("send",n),this.socket.send(m.encode(n))},parseMessage(e,t=null){let s,i,a,r,n,o;switch(s=e.id,e.type){case l.MESSAGE_COMMON:case l.MESSAGE_SELF:case l.MESSAGE_OTHER:i="text",a=e.mess,r=0,n="";break;case l.IMAGE_COMMON:case l.IMAGE_SELF:case l.IMAGE_OTHER:i="image",a=this.upload_url+e.mess.path,r=e.mess.size,n=e.mess.name;break;case l.FILE_COMMON:case l.FILE_SELF:case l.FILE_OTHER:i="file",a=this.upload_url+e.mess.path,r=e.mess.size,n=e.mess.name;break;case l.MUSIC_COMMON:case l.MUSIC_SELF:case l.MUSIC_OTHER:i="music",a=this.upload_url+e.mess.path,r=e.mess.size,n=e.mess.name;break;case l.GROUP_CREATE:{i="event";let e=t.user_id===this.user.id?"你":t.username;a=e+"创建了群聊",r=0,n="";break}case l.ERROR:case l.WARNING:case l.SYSTEM:s=u(),i="event",a=e.mess,r=0,n="";break}switch(e.type){case l.MESSAGE_OTHER:case l.IMAGE_OTHER:case l.FILE_OTHER:case l.MUSIC_OTHER:o=e.sender_id;break;default:o=e.receiver_id;break}return{id:s,status:"succeed",type:i,sendTime:e.timestamp,content:a,toContactId:o,fileSize:r,fileName:n,fromUser:{id:e.sender_id,displayName:t?t.username:"",avatar:t&&t.avatar?this.upload_url+t.avatar:l.DEFAULT_AVATAR}}},receiveMessage(e,t=null){let s=this.parseMessage(e,t);this.trace("parsed",s),this.im.appendMessage(s,!0)},updateContact(e,t){this.im.updateContact({id:e,...t})},addPersonalContact(e,t=""){let s={id:e.user_id,displayName:e.username,avatar:e.avatar?this.upload_url+e.avatar:l.DEFAULT_AVATAR,lastContent:t,index:"Personal",is_group:!1,is_online:e.is_online,query_time:((new Date).getTime()+performance.now())/1e3};this.im.appendContact(s)},addUser(e){return this.online_users.set(e.user_id,e)},getUser(e){return this.online_users.get(e)},getUserAsync(e,t=new Function){let s=this.getUser(e);if(s)t(s);else{this.sendMessage(l.USER_QUERY,e,e);let s=new Promise((t=>{this.query_next.set(e,t)}));s.then((e=>(this.query_next.delete(e.user_id),this.addPersonalContact(e),e))).then(t)}},addGroupContact(e,t="",s=new Map){let i={id:e.id,displayName:e.name,avatar:e.avatar?this.upload_url+e.avatar:l.DEFAULT_AVATAR,lastContent:t,index:"Group",online_total:0,is_group:!0,members:s,query_time:((new Date).getTime()+performance.now())/1e3};this.im.appendContact(i)},login(e){e.preventDefault();let t=this.username.trim();return t.length<3?(this.$notify({group:"tip",text:"用户名需要3字符以上",type:"error"}),!1):(this.socket.send(m.encode({type:l.USER_REGISTER,username:t.substr(0,30),password:this.password?this.password:"123456"})),!1)},getHistory(e,t){let s=e.query_time>0?e.query_time:((new Date).getTime()+performance.now())/1e3,i=e.is_group?l.HISTORY_MESSAGE_COMMON:l.HISTORY_MESSAGE_PERSONAL,a=new Promise(((t,a)=>{try{this.sendMessage(i,e.id,s),this.pull_next.set(e.id,t)}catch(r){a(r),this.trace(r)}}));a.then((s=>{let i=new Set,a=s.receiver_id,r=s.mess;this.pull_next.delete(a),r.length&&(e.query_time=r[0].timestamp-1e-4);for(let e of r){let t=e.sender_id,s=this.getUser(t);s||i.add(t)}let n=[];i.forEach((e=>{let t=new Promise((t=>{this.query_next.set(e,t),this.sendMessage(l.USER_QUERY,e,"","",e)}));t.then((e=>{this.addPersonalContact(e)})),n.push(t)})),Promise.all(n).then((()=>{let e=[];for(let t of r){let s=t.sender_id,i=this.getUser(s);t.timestamp=1e3*t.timestamp,e.push(this.parseMessage(t,i))}let s=r.length<10;t(e,s),i.forEach((e=>{this.query_next.delete(e)}))}))}))},send(e,t,s){try{if(this.trace("@send",e,s),s){let t=["audio/mpeg"];t.includes(s.type)&&(e.type="music")}let i,a=e.toContactId,r=this.im.findContact(a),n=!r.is_group+0,o={image:[l.IMAGE_COMMON,l.IMAGE_PERSONAL],file:[l.FILE_COMMON,l.FILE_PERSONAL],text:[l.MESSAGE_COMMON,l.MESSAGE_PERSONAL],music:[l.MUSIC_COMMON,l.MUSIC_PERSONAL]},c=o[e.type][n];if(!s)return this.sendMessage(c,a,e.content,e.id),t();switch(e.type){case"image":default:i=l.MAX_IMAGE_SIZE;break;case"music":i=l.MAX_MUSIC_SIZE;break;case"file":i=l.MAX_FILE_SIZE;break}if(s.size>i)return this.$notify({group:"tip",text:"文件太大，限制：<"+i/1048576+"M",type:"error"}),t({status:"failed"});this.socket.send(s);let d=e.id,u=m.sha256(s);u.then((e=>new Promise((t=>{this.upload_next.set(e,t)})))).then((i=>{let{hash:r,path:n}=i;this.upload_next.delete(r);let o={name:s.name,path:n,size:s.size};this.sendMessage(c,a,o,e.id),this.im.updateMessage({id:d,content:this.upload_url+n}),t()}))}catch(i){this.trace(i),t({status:"failed"})}},toggleDrawer(){this.im.changeDrawer({position:"rightInside",offsetY:33,width:242,height:this.$el.clientHeight-33})},messageClick(e,t,s){let i=s.toContactId;switch(this.updateContact(i,{unread:0}),s.type){case"image":this.imagePreview(s.content);break;case"file":window.open(s.content);break}},changeContact(e){let t=e.id;if(this.updateContact(t,{unread:0}),e.is_group&&t&&!e.members.size){let s=t;this.sendMessage(l.GROUP_QUERY_MEMBER,0,s);let i=new Promise((e=>{this.query_member_next.set(s,e)}));i.then((t=>{t.forEach((t=>{e.members.set(t.user_id,t)})),this.$forceUpdate()}))}},imagePreview(e){let t=document.querySelectorAll(".lemon-message__content img[src^=http]"),s=0;this.images=[],t.forEach(((t,i)=>{this.images.push(t.src),t.src===e&&(s=i)})),this.$viewerApi({images:this.images,options:{toolbar:!0,initialViewIndex:s}})},openNotice(){return""},openAddGroupUser(){},changeAvatar(){this.image_crop.show=!0},cropSuccess(e){fetch(e).then((e=>e.blob())).then((e=>{let t=m.sha256(e);return this.socket.send(e),t})).then((e=>new Promise((t=>{this.upload_next.set(e,t)})))).then((e=>{let{path:t,size:s,hash:i}=e;this.upload_next.delete(i),this.sendMessage(l.USER_AVATAR_UPLOAD,"0",{path:t,size:s})})).catch((e=>{this.trace(e)}))}}}}class g extends d{process(e,t){switch(t.type){case l.GROUP_CREATE:{let s=t.mess;e.groups.set(s.id,s),e.addGroupContact(s);let i=s.admin_id;e.getUserAsync(i,(s=>{e.receiveMessage(t,s)}));break}case l.GROUP_QUERY_LIST:{let s=t.mess;for(let t of Object.keys(s)){let i=s[t];i.id=t,e.groups.set(t,i),e.addGroupContact(i," ")}break}case l.GROUP_QUERY_MEMBER:{let s=t.mess,i=s.group_id,a=s.members,r=e.query_member_next.get(i);r&&r(a);break}case l.GROUP_QUERY_INFO:{let s=t.mess,i=s.id,a=e.query_group_next.get(i);a&&a(s);break}default:this.next.process(e,t);break}}}class f extends _{getData(){return{group_name:"",group_available_users:new Map,group_chosen_users:new Map,left_options:[],right_options:[],groups:new Map,group_menu:[{text:"发消息",visible:e=>e.contact.user_id!==this.user.id,click:(e,t,s)=>{const{IMUI:i,contact:a}=t;i.$parent.addPersonalContact(a,"临时会话"),i.changeContact(a.user_id),s(),i.closeDrawer()}},{text:"移除大厅",visible:e=>{const{IMUI:t,contact:s}=e;return s.user_id!==this.user.id&&this.user.is_super_admin&&"0"===t.getCurrentContact().id},click:(e,t,s)=>{const{contact:i}=t;this.sendMessage(l.USER_REMOVE,i.user_id),s()}}]}}getMethods(){return{addGroup(){this.group_name="",this.group_available_users=new Map(this.online_users),this.group_available_users.delete(this.user.id),this.group_chosen_users.clear(),this.$modal.show("group-modal")},moveToLeft(){this.right_options.forEach((e=>{let t=this.group_chosen_users.get(e);this.group_available_users.set(e,t),this.group_chosen_users.delete(e)})),this.$forceUpdate()},moveToRight(){this.left_options.forEach((e=>{let t=this.group_available_users.get(e);this.group_chosen_users.set(e,t),this.group_available_users.delete(e)})),this.$forceUpdate()},groupCancel(){this.$modal.hide("group-modal")},groupSubmit(){if(""===this.group_name)return this.$notify({group:"tip",text:"请输入群聊名称",type:"error"});let e=this.group_chosen_users.size;if(e<2)return this.$notify({group:"tip",text:"群聊人数不能少于2人",type:"error"});let t={name:this.group_name,members:[...this.group_chosen_users.keys()]};this.sendMessage(l.GROUP_CREATE,0,t),this.$modal.hide("group-modal")}}}}class v{constructor(e){const t=new AudioContext;this.analyser=t.createAnalyser(),this.source=t.createMediaStreamSource(e),this.source.connect(this.analyser),this.drawVisual=null}visualize(e,t="sine-wave"){const s=e.getContext("2d"),i=e.width,a=e.height;switch(t){case"sine-wave":{this.analyser.fftSize=512;const e=this.analyser.fftSize;console.log(e);const t=new Uint8Array(e);s.clearRect(0,0,i,a);const r=()=>{this.drawVisual=requestAnimationFrame(r),this.analyser.getByteTimeDomainData(t),s.fillStyle="rgb(200, 200, 200)",s.fillRect(0,0,i,a),s.lineWidth=1,s.strokeStyle="rgb(0, 0, 0)",s.beginPath();const n=1*i/e;let o=0;for(let i=0;i<e;i++){const e=t[i]/128,r=e*a/2;0===i?s.moveTo(o,r):s.lineTo(o,r),o+=n}s.lineTo(i,a/2),s.stroke()};r();break}case"frequency-bars":{this.analyser.fftSize=256;const e=this.analyser.frequencyBinCount;console.log(e);const t=new Uint8Array(e);s.clearRect(0,0,i,a);const r=()=>{this.drawVisual=requestAnimationFrame(r),this.analyser.getByteFrequencyData(t),s.fillStyle="rgb(0, 0, 0)",s.fillRect(0,0,i,a);const n=i/e*2.5;let o=0;for(let i=0;i<e;i++){const e=t[i];s.fillStyle="rgb("+(e+100)+",50,50)",s.fillRect(o,a-e/2,n,e/2),o+=n+1}};r();break}}}close(){cancelAnimationFrame(this.drawVisual),this.source.disconnect(),this.source=null,this.analyser=null}}class y extends d{process(e,t){switch(t.type){case l.RTC_CREATE:{let s=t.mess,i=t.sender_id,a=t.receiver_id;if(i===e.user.id)return e.rtc_room_id=s.room_id,void(e.rtc_receiver_id=a);if(e.rtc_running){let t=e.user.displayName+" 正在聊天中";return void e.sendMessage(l.RTC_MESSAGE,i,{type:"deny",message:t})}let r=s.video,n=s.is_group,o='<div class="flex vertical-center">';o+='<span class="call-button"></span>',o+="<span>",o+=n?"多人聊天":"单人聊天",o+="</span>",o+="</div>";let c=r?"视频":"语音";e.getUserAsync(i,(t=>{e.$modal.show("dialog",{title:o,text:`<b>${t.username}</b> 邀请您${c}通话，是否接听？`,buttons:[{title:"拒绝",handler:()=>{e.$modal.hide("dialog"),e.sendMessage(l.RTC_MESSAGE,i,{type:"deny",message:e.user.displayName+" 拒绝了您的通话请求"})}},{title:"接听",handler:()=>{e.$modal.hide("dialog"),e.$modal.show("rtc-modal"),e.rtc_room_id=s.room_id,e.rtc_receiver_id=a,e.video_flag=r,e.rtc.setConstraints({audio:!0,video:r}),e.rtc.open().then((t=>{e.setLocalStream(t),e.rtc_running=!0;let a=e.rtc.create();e.remote_medias.set(a,null),e.rtc.addTrack(a),e.associateKeyWithSender(a,i),e.sendMessage(l.RTC_JOIN,"0",s)})).catch((t=>{e.trace(t),e.rtc_running=!0}))}}]})}));break}case l.RTC_JOIN:{let s=t.mess,i=t.sender_id;if(e.rtc_room_id=s.room_id,i===e.user.id)return;let a=e.rtc.create();e.remote_medias.set(a,null),e.rtc.addTrack(a),e.associateKeyWithSender(a,i);break}case l.RTC_MESSAGE:{let s=t.sender_id,i=t.mess,a=i.type;switch(a){case"offer":{let t=-1;if(e.rtc_sender_key.has(s))t=e.rtc_sender_key.get(s),e.trace("reuse connection",s,t);else{let t=e.rtc.getPeerConnectionLastId();e.associateKeyWithSender(t,s)}let a=i.description;e.rtc.handleVideoOfferMsg(a,t).then((({description:t})=>{e.sendAnswer(s,t)}));break}case"answer":{let t=e.rtc_sender_key.get(s);e.rtc.handleVideoAnswerMsg(t,i.description);break}case"new-ice-candidate":{let t=i.candidate;if(e.rtc_sender_key.has(s)){let i=e.rtc_sender_key.get(s);e.rtc.handleNewICECandidateMsg(i,t)}else{let i;e.trace("record candidate",s,t),e.candidates.has(s)?(i=e.candidates.get(s),i.push(t)):i=[t],e.candidates.set(s,i)}break}case"deny":{let t=i.message;e.$notify({group:"tip",text:t,type:"error"});break}}break}case l.RTC_CLOSE:case l.RTC_OFFLINE:{let s=t.sender_id;if(e.rtc_sender_key.has(s)){let t=e.rtc_sender_key.get(s);e.rtc.close(t)}break}case l.RTC_EXIT:{let s=t.sender_id;if(s===e.user.id)return;let i=t.mess;e.rtc_running&&i.room_id===e.rtc_room_id?(e.$notify({group:"tip",text:"聊天已经结束",type:"warn"}),e.hangUp(!1)):e.$modal.hide("dialog");break}default:this.next.process(e,t);break}}}class E extends _{getData(){return{rtc:null,video_flag:!0,local_media:null,remote_medias:new Map,remote_users:new Map,voice_visualizes:new Map,clock_text:"",clock_timer:0,candidates:new Map,rtc_key_sender:new Map,rtc_sender_key:new Map,rtc_room_id:"",rtc_receiver_id:"",rtc_running:!1,rtc_minimize:!1}}getMethods(){return{hangUp(e=!0){if(this.$modal.hide("rtc-modal"),this.rtc_running=!1,this.rtc_key_sender.clear(),this.rtc_sender_key.clear(),this.remote_users.clear(),this.rtc.closeAll(),this.closeLocalStream(),this.clockStop(),this.closeVisualize(),e){let e=this.im.findContact(this.rtc_receiver_id);this.sendMessage(l.RTC_CLOSE,this.rtc_receiver_id,{is_group:e.is_group,room_id:this.rtc_room_id})}this.rtc_room_id="",this.rtc_receiver_id=""},minimize(){this.rtc_minimize=!0},maximize(){this.rtc_minimize=!1},setMute(e){e.target.muted=!0},clockStart(){if(this.clock_timer)return;let e=Date.now();this.clock_timer=setInterval((()=>{let t=Date.now()-e,s=new Date(t);this.clock_text=s.formatUTC("H:i:s")}),1e3)},clockStop(){clearInterval(this.clock_timer),this.clock_timer=0,this.clock_text=""},closeVisualize(){for(let e of this.voice_visualizes.values())e.close();this.voice_visualizes.clear()},associateKeyWithSender(e,t){this.rtc_key_sender.set(e,t),this.rtc_sender_key.set(t,e),this.getUserAsync(t,(t=>{this.remote_users.set(e,t)}))},setLocalStream(e){this.trace("set local stream",...arguments),this.local_media=e;let t=document.querySelector("#local-canvas"),s=new v(e);s.visualize(t),this.voice_visualizes.set("local",s)},closeLocalStream(){this.trace("close local stream"),this.local_media&&(this.local_media.getTracks().forEach((e=>e.stop())),this.local_media=null,this.candidates.clear())},sendAnswer(e,t){this.trace("send answer",...arguments),this.sendMessage(l.RTC_MESSAGE,e,{type:"answer",description:t})},onNegotiateReady(e,t){this.trace("negotiate ready",...arguments);let s=this.rtc_key_sender.get(e);this.sendMessage(l.RTC_MESSAGE,s,{type:"offer",description:t})},onIceCandidate(e,t){if(this.trace("candidate",...arguments),null===t)return;let s=this.rtc_key_sender.get(e);if(this.trace("ice",s),this.sendMessage(l.RTC_MESSAGE,s,{type:"new-ice-candidate",candidate:t}),this.candidates.has(s)){let t=this.candidates.get(s);this.trace("handle candidates",t);for(let s of t)this.rtc.handleNewICECandidateMsg(e,s);this.candidates.set(s,[])}},onTrack(e,t){this.trace("track",...arguments);let s=t[0],i=this.remote_medias.get(e)===s;i||(this.remote_medias.set(e,s),this.$forceUpdate(),this.$nextTick((()=>{let t=document.querySelector("#remote-canvas-"+e);this.voice_visualizes.has(e)&&(this.voice_visualizes.get(e).close(),this.voice_visualizes.delete(e));let i=new v(s);i.visualize(t),this.voice_visualizes.set(e,i)})),this.clockStart())},onRemoteSteamClose(e){this.trace("remote stream close",...arguments),this.remote_medias.has(e)&&(this.remote_medias.get(e)&&this.remote_medias.get(e).getTracks().forEach((e=>e.stop())),this.remote_medias.delete(e),this.$forceUpdate())}}}}class S extends d{process(e,t){e.$notify({group:"tip",text:"未知的消息类型："+t.type,type:"warn"})}}var w,C,A={name:"App",mixins:[new p,new f,new E],mounted(){const e=this.$createElement,{im:t}=this.$refs;this.im=t,this.socket=new WebSocket(this.server_url),this.socket.addEventListener("open",this.onOpen),this.socket.addEventListener("message",this.onMessage),this.socket.addEventListener("close",this.onClose),this.socket.addEventListener("error",this.onError),this.im.initMenus([{name:"messages"},{name:"contacts"}]),this.im.initEmoji(n);let s=new h,i=new g,a=new y,r=new S;s.setNext(i),i.setNext(a),a.setNext(r),this.message_handler=s,this.rtc=new o,this.rtc.setCallbacks({onTrack:this.onTrack,onNegotiateReady:this.onNegotiateReady,onIceCandidate:this.onIceCandidate,onRemoteSteamClose:this.onRemoteSteamClose}),this.im.initEditorTools([{name:"emoji"},{name:"uploadImage"},{name:"uploadDoc",title:"上传文档",click:()=>{this.im.$refs.editor.selectFile(".doc,.docx,.xls,.xlsx")},render:()=>e("i",{class:"weui-icon-outlined-note"})},{name:"uploadMusic",title:"上传音乐",click:()=>{this.im.$refs.editor.selectFile(".mp3")},render:()=>e("i",{class:"weui-icon-outlined-music"})},{name:"videoChat",title:"视频聊天",click:()=>{if(this.rtc_minimize)return this.$notify({group:"tip",text:"已在通话中",type:"warn"});this.$modal.show("rtc-modal"),this.rtc_room_id="";let e=this.im.getCurrentContact(),t=!0;this.video_flag=t,this.rtc.setConstraints({audio:!0,video:t}),this.rtc.open().then((s=>{this.setLocalStream(s),this.rtc_running=!0;let i=e.is_group;this.sendMessage(l.RTC_CREATE,e.id,{is_group:i,video:t})})).catch((e=>{this.trace(e),this.rtc_running=!0}))},render:()=>e("i",{class:"weui-icon-outlined-video-call"})},{name:"VoiceChat",title:"语音聊天",click:()=>{if(this.rtc_minimize)return this.$notify({group:"tip",text:"已在通话中",type:"warn"});this.$modal.show("rtc-modal"),this.rtc_room_id="";let e=this.im.getCurrentContact(),t=!1;this.video_flag=t,this.rtc.setConstraints({audio:!0,video:t}),this.rtc.open().then((s=>{this.setLocalStream(s),this.rtc_running=!0;let i=e.is_group;this.sendMessage(l.RTC_CREATE,e.id,{is_group:i,video:t})})).catch((e=>{this.trace(e),this.rtc_running=!0}))},render:()=>e("i",{class:"weui-icon-outlined-mike"})}]),this.im.setLastContentRender("music",(t=>e("span",["[音乐]",t.fileName]))),this.addGroupContact({id:"0",name:"大厅",avatar:""},"",this.online_users)}},M=A,R=s(1656),k=(0,R.A)(M,a,r,!1,null,null,null),b=k.exports,x=s(5532),O=s.n(x),T=s(9154),I=s.n(T),U={name:"lemonMessageMusic",inheritAttrs:!1,inject:["IMUI"],render(){const e=arguments[0];return e("lemon-message-basic",I()([{class:"lemon-message-audio"},{props:{...this.$attrs}},{scopedSlots:{content:t=>e("div",[e("div",{class:"lemon-message__audio_name"},[e("i",["🎵"]),e("span",[t.fileName])]),e("audio",{attrs:{controls:!0,src:t.content,title:t.fileName}})])}}]))}},j=U,N=(0,R.A)(j,w,C,!1,null,null,null),L=N.exports,z=s(5619),G=s.n(z),P=s(9115),D=s.n(P),F=s(5369),$=s(3113);i["default"].component(L.name,L),i["default"].config.productionTip=!1,i["default"].use(O()),i["default"].use(G(),{dialog:!0}),i["default"].use(D()),i["default"].use(F.Ay),i["default"].component("image-crop",$.A),new i["default"]({render:e=>e(b)}).$mount("#app")}},t={};function s(i){var a=t[i];if(void 0!==a)return a.exports;var r=t[i]={id:i,loaded:!1,exports:{}};return e[i].call(r.exports,r,r.exports,s),r.loaded=!0,r.exports}s.m=e,function(){var e=[];s.O=function(t,i,a,r){if(!i){var n=1/0;for(d=0;d<e.length;d++){i=e[d][0],a=e[d][1],r=e[d][2];for(var o=!0,c=0;c<i.length;c++)(!1&r||n>=r)&&Object.keys(s.O).every((function(e){return s.O[e](i[c])}))?i.splice(c--,1):(o=!1,r<n&&(n=r));if(o){e.splice(d--,1);var l=a();void 0!==l&&(t=l)}}return t}r=r||0;for(var d=e.length;d>0&&e[d-1][2]>r;d--)e[d]=e[d-1];e[d]=[i,a,r]}}(),function(){s.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return s.d(t,{a:t}),t}}(),function(){s.d=function(e,t){for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})}}(),function(){s.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){s.hmd=function(e){return e=Object.create(e),e.children||(e.children=[]),Object.defineProperty(e,"exports",{enumerable:!0,set:function(){throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+e.id)}}),e}}(),function(){s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){s.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){var e={524:0};s.O.j=function(t){return 0===e[t]};var t=function(t,i){var a,r,n=i[0],o=i[1],c=i[2],l=0;if(n.some((function(t){return 0!==e[t]}))){for(a in o)s.o(o,a)&&(s.m[a]=o[a]);if(c)var d=c(s)}for(t&&t(i);l<n.length;l++)r=n[l],s.o(e,r)&&e[r]&&e[r][0](),e[r]=0;return s.O(d)},i=self["webpackChunkhtml_v2"]=self["webpackChunkhtml_v2"]||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))}();var i=s.O(void 0,[504],(function(){return s(1643)}));i=s.O(i)})();
//# sourceMappingURL=app.63e0d1ce.js.map